<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>OC Baccarat AI [God-Tier]</title>
<link rel="manifest" href="manifest.json">
<style>
/* ========== 1. ROOT VARIABLES & GLOBAL RESET ========== */
:root{
  --bg: #000000;
  --bg-gradient: linear-gradient(180deg, #0a0a0a, #000000);
  --card: #0d0d0d;
  --card-border: rgba(255, 255, 255, 0.08);
  --shadow: rgba(0, 0, 0, 0.6);
  --glass: rgba(255, 255, 255, 0.03);
  --glass-light: rgba(255, 255, 255, 0.05);
  
  --text: #ececec;
  --text-muted: #888;
  --text-dark: #555;
  
  --blue: #007bff;
  --blue-glow: 0 0 18px rgba(0,123,255,0.4);
  --red: #dc3545;
  --red-glow: 0 0 18px rgba(220,53,69,0.4);
  --green: #28a745;
  --green-glow: 0 0 18px rgba(40,167,69,0.4);
  --gold: #d4af37;
  --gold-glow: 0 0 18px rgba(212,175,55,0.4);
  
  --warn: #ffc107;
  --error: #dc3545;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Noto Sans Thai",Arial;color:var(--text);background:var(--bg-gradient)}
button,input,select,textarea{font-family:inherit}

/* ========== 2. APP LAYOUT & GRID (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚ÄºÔ∏è‚ÄºÔ∏è) ========== */
.app{max-width:980px;margin:0 auto;padding:12px;display:none} /* ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° */
/* (‡∏•‡∏ö .grid-main 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏¥‡πâ‡∏á) */
.grid-main{
    display:grid;
    grid-template-columns: 1fr; /* (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå) */
    gap:12px;
    margin-top:12px;
}
.grid-col-1{display:flex;flex-direction:column;gap:12px;min-width:0} /* (min-width: 0 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≤‡∏ñ‡∏≤‡πÅ‡∏Å‡πâ‡∏à‡∏≠‡∏•‡πâ‡∏ô) */

/* ========== 3. PANELS (CARDS) ========== */
.panel{
  background:var(--card);
  border-radius:14px;
  padding:14px 16px;
  border:1px solid var(--card-border);
  box-shadow:0 10px 40px var(--shadow);
}
.panel h2{font-size:16px;margin:0 0 12px 0;color:var(--text);border-bottom:1px solid var(--card-border);padding-bottom:10px}
.panel h2 .muted{font-size:13px;color:var(--text-muted);font-weight:400;margin-left:8px}

/* ========== 4. HEADER & LOGO ========== */
.header{display:flex;justify-content:space-between;align-items:center}
.h-title{display:flex;gap:12px;align-items:center}
.logo{
  width:46px;height:46px;border-radius:10px;
  background:linear-gradient(135deg,var(--gold),#c79b28);
  display:flex;align-items:center;justify-content:center;
  color:#000;font-weight:900;font-size:20px;
  box-shadow:0 6px 18px rgba(212,175,55,0.18), inset 0 -4px 12px rgba(255,255,255,0.06);
}
.header h1{font-size:18px;margin:0 0 4px 0}
.counter{font-size:13px;color:var(--text-muted)}

/* ========== 5. PREDICTION SIGNAL (Main) ========== */
.pred-card{
  display:flex;flex-direction:column;align-items:center;gap:12px;
  background:linear-gradient(180deg, var(--glass), rgba(0,0,0,0.1));
}
.pred-circle{
  width:160px;height:160px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  font-size:48px;font-weight:900;color:var(--text);
  text-shadow:0 4px 18px var(--shadow);
  box-shadow:0 12px 40px var(--shadow), inset 0 -8px 24px var(--glass);
  transition:all 0.3s ease;
  background:linear-gradient(180deg,#333,#111); /* Default 'WAIT' state */
}
/* (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô "‡∏ä‡∏µ‡∏û‡∏à‡∏£" ‚ÄºÔ∏è‚ÄºÔ∏è) */
.pred-circle.waiting {
    animation: breathing 2.5s infinite ease-in-out;
}
@keyframes breathing {
    0% { box-shadow:0 12px 40px var(--shadow), inset 0 -8px 24px var(--glass); }
    50% { box-shadow:0 12px 50px rgba(150,150,150,0.2), inset 0 -8px 24px var(--glass); }
    100% { box-shadow:0 12px 40px var(--shadow), inset 0 -8px 24px var(--glass); }
}
/* (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô "‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤" ‚ÄºÔ∏è‚ÄºÔ∏è) */
.pred-circle.P{background:linear-gradient(180deg,var(--blue),#1e6fe8); box-shadow:var(--blue-glow),0 12px 40px var(--shadow), inset 0 -8px 24px var(--glass); animation: pulse-blue 1s ease-out;}
.pred-circle.B{background:linear-gradient(180deg,var(--red),#b02a2a); box-shadow:var(--red-glow),0 12px 40px var(--shadow), inset 0 -8px 24px var(--glass); animation: pulse-red 1s ease-out;}
.pred-circle.T{background:linear-gradient(180deg,var(--green),#1f8b3a); box-shadow:var(--green-glow),0 12px 40px var(--shadow), inset 0 -8px 24px var(--glass); animation: pulse-green 1s ease-out;}
@keyframes pulse-blue { from { box-shadow:0 0 60px rgba(0,123,255,0.8); } to { box-shadow:var(--blue-glow); } }
@keyframes pulse-red { from { box-shadow:0 0 60px rgba(220,53,69,0.8); } to { box-shadow:var(--red-glow); } }
@keyframes pulse-green { from { box-shadow:0 0 60px rgba(40,167,69,0.8); } to { box-shadow:var(--green-glow); } }

.pred-muted{font-size:13px;color:var(--text-muted)}
.progress{width:100%;height:4px;background:var(--glass);border-radius:4px;overflow:hidden;margin-top:4px}
.progress > div{height:100%;width:0;background:var(--gold);transition:width 0.5s ease}

/* ========== 6. BUTTON CONTROLS (Smart Interface) ========== */
.controls-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;
  position:relative; /* (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢) */
}
.btn{
  position:relative; overflow:hidden; /* for gloss effect */
  padding:16px;border-radius:10px;border:0;
  font-weight:800;font-size:18px;color:var(--text);
  box-shadow:0 8px 20px var(--shadow);
  cursor:pointer;
  transition:all 0.2s ease;
  user-select:none; /* (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) */
}
.btn:active{transform:scale(0.97);box-shadow:0 4px 10px var(--shadow)}
/* (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: Dynamic Gloss (Placeholder) ‚ÄºÔ∏è‚ÄºÔ∏è) */
.btn::after{
  content:'';position:absolute;top:0;left:-50%;width:200%;height:60%;
  background:linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.02));
  transform:rotate(15deg);
}
.btnP{background:linear-gradient(180deg,var(--blue),#1e6fe8)}
.btnB{background:linear-gradient(180deg,var(--red),#b02a2a)}
.btnT{background:linear-gradient(180deg,var(--green),#1f8b3a);grid-column:1 / -1}

/* (‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢ '‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á' - Flyout Menu) */
.flyout-menu{
  display:none; /* (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) */
  position:absolute;
  bottom:100%; /* (‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô) */
  left:0;right:0;
  margin:0 10% 10px 10%; /* (‡∏•‡∏≠‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á) */
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:10px;
  box-shadow:0 -10px 40px var(--shadow);
  z-index:10;
  animation: flyout-in 0.2s ease-out;
}
.flyout-menu button{
  display:block;width:100%;padding:14px;
  background:transparent;border:0;color:var(--text);
  font-size:15px;font-weight:600;
}
.flyout-menu button:first-child{border-bottom:1px solid var(--card-border)}
.flyout-menu button:hover{background:var(--glass-light)}
@keyframes flyout-in {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}

.btn-small{
  padding:8px 12px;font-size:13px;border-radius:8px;font-weight:600;
  background:var(--glass-light);
  border:1px solid var(--card-border);
  /* (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡πâ‡∏≠‡∏ô‡∏ï‡πå‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß ‚ÄºÔ∏è‚ÄºÔ∏è) */
  color: var(--text);
}
.btn-small:hover{background:var(--glass)}

/* ========== 7. STATS & WINRATE ========== */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:10px;width:100%;text-align:center;margin-top:10px}
.stat-item h3{font-size:18px;margin:0 0 4px 0;color:var(--text)}
.stat-item .label{font-size:12px;color:var(--text-muted)}
.stat-item .win{color:var(--green)}
.stat-item .lose{color:var(--red)}

/* ========== 8. BIG ROAD (‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ========== */
/* 8A. (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏∏‡πâ‡∏°) - (‚ÄºÔ∏è‚ÄºÔ∏è ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‚ÄºÔ∏è‚ÄºÔ∏è) */
.bigroad-wrap{
  min-height:240px;
  position:relative;
  overflow-x:auto; /* (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "Scroll" ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) */
  min-width:0; /* (‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏Ñ‡∏≤‡∏ñ‡∏≤" ‡∏õ‡∏£‡∏≤‡∏ö Flexbox) */
}
/* 8B. (‡∏ï‡∏≤‡∏£‡∏≤‡∏á) - (‚ÄºÔ∏è‚ÄºÔ∏è ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‚ÄºÔ∏è‚ÄºÔ∏è) */
.bigroad{
  /* width:100%; (‡∏•‡∏ö) */
  height:220px;
  /* overflow-x:auto; (‡∏•‡∏ö) */
  overflow-y:hidden;
  background:transparent;padding:10px 6px;
  display:grid;grid-auto-flow:column;grid-auto-columns:36px;
  gap:6px;
  border-top:1px solid var(--card-border);margin-top:12px;
}
/* ========== (‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ========== */

.br-col{display:grid;grid-auto-rows:36px;gap:6px}
.br-cell{
  width:34px;height:34px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:var(--text);font-size:13px;
  box-shadow:0 6px 18px var(--shadow);
  /* (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: TIE Line ‚ÄºÔ∏è‚ÄºÔ∏è) */
  position: relative;
  overflow: hidden;
}
/* (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: TIE Line ‚ÄºÔ∏è‚ÄºÔ∏è) */
.br-cell .tie-line {
    position: absolute;
    width: 140%;
    height: 4px;
    background: var(--green);
    transform: rotate(45deg);
    box-shadow: 0 0 10px var(--green-glow);
}
/* Cell types for 2 vs 3 cards */
.br-P{background:var(--blue)} /* 2-card win (solid) */
.br-P3{background:transparent; border:3px solid var(--blue)} /* 3-card win (outline) */
.br-P_UNKNOWN{background:rgba(0,123,255,0.5)} /* (Lazy Button) */
.br-B{background:var(--red)}
.br-B3{background:transparent; border:3px solid var(--red)}
.br-B_UNKNOWN{background:rgba(220,53,69,0.5)} /* (Lazy Button) */
/* .br-T (‡∏•‡∏ö: TIE ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏°) */


/* ========== 9. AI DASHBOARD & SYSTEM STATUS (‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ Modal) ========== */
.kv-list{display:flex;flex-direction:column;gap:10px;font-size:13px}
.kv{display:flex;justify-content:space-between;align-items:center}
.kv .key{color:var(--text-muted)}
.kv .val{color:var(--text);font-weight:600}
.kv .val.P{color:var(--blue)}
.kv .val.B{color:var(--red)}
.kv .val.T{color:var(--green)}
.kv .val.warn{color:var(--warn)}
.kv .val.ok{color:var(--green)}
.kv .val.err{color:var(--error)}
/* (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Shadow Mode Winrate) */
.expert-winrate{
  font-size:11px; color:var(--text-muted); margin-left:8px;
  background:var(--glass); padding:2px 4px; border-radius:4px;
}
/* (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Trigger Slider) */
.slider-controls{ margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end; }

/* ========== 10. APP CONTROLS (Icons) ========== */
.app-controls{display:flex;gap:10px}
.icon-btn{
  background:var(--glass-light);color:var(--text-muted);
  border:1px solid var(--card-border);
  width:38px;height:38px;border-radius:10px;
  font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.icon-btn:hover{background:var(--glass);color:var(--text)}

/* ========== 11. MODALS (Hidden Panels) ========== */
.modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);
  z-index:100;display:none; /* Hidden by default */
}
.modal-content{
  position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);
  width:90%;max-width:500px;
  background:var(--card);border-radius:14px;
  border:1px solid var(--card-border);
  box-shadow:0 10px 60px var(--shadow);
  padding:20px;
  /* (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÉ‡∏´‡πâ Modal ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å */
  max-height: 80vh;
  overflow-y: auto;
}
.modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);padding-bottom:10px;margin-bottom:16px}
.modal-header h2{margin:0;font-size:18px}
.modal-close{font-size:24px;cursor:pointer;color:var(--text-muted)}
/* Specific modal styles */
#settingsRiskSlider{width:100%}
#historyEditorTable{width:100%;font-size:13px;border-collapse:collapse}
#historyEditorTable th, #historyEditorTable td{padding:8px;text-align:left;border-bottom:1px solid var(--card-border)}
/* Tooltip/Help styles */
.tooltip-content{font-size:14px;line-height:1.6;color:var(--text)}
.tooltip-content strong{color:var(--gold)}

/* (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: "‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô '‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î'" ‚ÄºÔ∏è‚ÄºÔ∏è) */
#confirmModal .modal-content { max-width: 320px; }
#confirmModalBody { font-size: 16px; line-height: 1.6; margin-bottom: 20px; }
#confirmModalButtons { display: flex; gap: 10px; }

/* ========== 12. ERROR & STATUS OVERLAYS ========== */
.status-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(220,53,69,0.9); /* Red error overlay */
  backdrop-filter:blur(10px);
  z-index:200;display:none; /* Hidden by default */
  flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:20px;
}
.status-overlay h1{font-size:24px;color:#fff}
.status-overlay p{font-size:16px;color:#fff;max-width:400px}
/* Re-train Progress */
#retrainOverlay{background:rgba(0,0,0,0.9)}
#retrainProgress{width:80%;max-width:400px;height:20px;background:var(--glass);border-radius:10px;overflow:hidden;margin-top:16px}
#retrainProgressBar{width:0;height:100%;background:var(--gold);transition:width 0.2s ease}

/* ========== 13. LOADING OVERLAY ========== */
#loadingOverlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:var(--bg-gradient);
  z-index:9999;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  transition: opacity 0.5s ease;
}
.loader-logo{
  width:60px;height:60px;border-radius:12px;
  background:linear-gradient(135deg,var(--gold),#c79b28);
  display:flex;align-items:center;justify-content:center;
  color:#000;font-weight:900;font-size:24px;
  box-shadow:0 6px 18px rgba(212,175,55,0.18);
  animation: pulse 2s infinite ease-in-out;
}
.loader-text{
  margin-top:16px;
  font-size:14px;
  color:var(--text-muted);
}
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}
</style>
</head>
<body>

<div id="loadingOverlay">
  <div class="loader-logo">OC</div>
  <div class="loader-text" id="loaderStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏∏‡πà‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á '‡∏™‡∏°‡∏≠‡∏á AI' (IndexedDB)...</div>
</div>
<div class="app" id="app">

  <div class="header">
    <div class="h-title">
      <div class="logo">OC</div>
      <div>
        <h1>OC Baccarat AI</h1>
        <div class="counter" id="appStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>
      </div>
    </div>
    <div class="app-controls">
      <button class="icon-btn" id="btnToggleHistoryHub" title="‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" onclick="openModal('historyHubModal')">üóÇÔ∏è</button>
      <button class="icon-btn" id="btnToggleSettings" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
      <button class="icon-btn" id="btnToggleHelp" title="‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠" onclick="openModal('helpModal')">‚ùì</button>
    </div>
  </div>

  <div class="grid-main">

    <div class="grid-col-1">
      
      <div class="panel pred-card">
        <div id="predCircle" class="pred-circle">-</div>
        <div id="confText" class="pred-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: -%</div>
        <div class="progress"><div id="progressBar"></div></div>
        <div id="condBox" class="pred-muted" style="width:100%;text-align:center">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏•...</div>
      </div>

      <div class="panel">
        <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå <span class="muted">(‡πÅ‡∏ï‡∏∞ = ‡πÄ‡∏£‡πá‡∏ß / ‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á = ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</span></h2>
        <div class="controls-grid" id="controlsGrid">
          <button class="btn btnP" id="btnPlayer">PLAYER</button>
          <button class="btn btnB" id="btnBanker">BANKER</button>
          <button class="btn btnT" id="btnTie">TIE</button>
          
          <div class="flyout-menu" id="flyoutP">
            <button onclick="onResult('P3')">PLAYER (3 ‡πÉ‡∏ö)</button>
            <button onclick="onResult('P2')">PLAYER (2 ‡πÉ‡∏ö)</button>
          </div>
          <div class="flyout-menu" id="flyoutB">
            <button onclick="onResult('B3')">BANKER (3 ‡πÉ‡∏ö)</button>
            <button onclick="onResult('B2')">BANKER (2 ‡πÉ‡∏ö)</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û Signal (‡∏ï‡∏≤‡∏ó‡∏µ‡πà AI ‡∏™‡πà‡∏á Signal ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <h3 id="winRateShoe" class="win">- %</h3>
            <div class="label">Winrate (‡∏Ç‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
          </div>
          <div class="stat-item">
            <h3><span id="winShoe" class="win">0</span> / <span id="loseShoe" class="lose">0</span></h3>
            <div class="label">‡∏ä‡∏ô‡∏∞ / ‡πÅ‡∏û‡πâ (‡∏Ç‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
          </div>
          <div class="stat-item">
            <h3 id="winRateGlobal">- %</h3>
            <div class="label">Winrate (‡∏£‡∏ß‡∏°)</div>
          </div>
          <div class="stat-item">
            <h3><span id="winGlobal">0</span> / <span id="loseGlobal">0</span></h3>
            <div class="label">‡∏ä‡∏ô‡∏∞ / ‡πÅ‡∏û‡πâ (‡∏£‡∏ß‡∏°)</div>
          </div>
        </div>
      </div>
      
      <div class="panel bigroad-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Big Road <span class="muted">(‡∏ó‡∏∂‡∏ö=2‡πÉ‡∏ö / ‡πÇ‡∏õ‡∏£‡πà‡∏á=3‡πÉ‡∏ö)</span></h2>
          <div class="kv" style="font-size:13px">‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á: <span id="countdownText" style="color:var(--warn)">20</span>s</div>
        </div>
        <div id="bigroad" class="bigroad">
          </div>
      </div>
      
      <div id="advancedPanels" style="display:flex; flex-direction:column; gap:12px;">
          <div class="panel">
            <h2>üß† ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î "‡∏™‡∏°‡∏≠‡∏á AI" (Shadow Mode)</h2>
            <div class="kv-list" id="aiDashboard">
              <div class="kv"><div class="key">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å <span class="expert-winrate" id="perfMain">--%</span></div><div class="val" id="expMain">-</div></div>
              <div class="kv"><div class="key">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡πà‡∏≠‡∏¢ <span class="expert-winrate" id="perfDerived">--%</span></div><div class="val" id="expDerived">-</div></div>
              <div class="kv"><div class="key">‡∏Å‡∏é‡πÑ‡∏û‡πà <span class="expert-winrate" id="perfRules">--%</span></div><div class="val" id="expRules">-</div></div>
              <div class="kv"><div class="key">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏ô <span class="expert-winrate" id="perfStats">--%</span></div><div class="val" id="expStats">-</div></div>
              <div class="kv"><div class="key">‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏© <span class="expert-winrate" id="perfSpecial">--%</span></div><div class="val" id="expSpecial">-</div></div>
              <div class="kv"><div class="key">Sim: ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ <span class="expert-winrate" id="perfSimA">--%</span></div><div class="val" id="expSimA">-</div></div>
              <div class="kv"><div class="key">Sim: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö <span class="expert-winrate" id="perfSimB">--%</span></div><div class="val" id="expSimB">-</div></div>
              <div class="kv"><div class="key">Sim: ‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô <span class="expert-winrate" id="perfSimC">--%</span></div><div class="val" id="expSimC">-</div></div>
              <div class="kv"><div class="key">‡∏ô‡∏±‡∏Å‡∏Ç‡∏∏‡∏î (Miner) <span class="expert-winrate" id="perfMiner">--%</span></div><div class="val" id="expMiner">-</div></div>
              
              <div class="kv" style="border-top:1px solid var(--card-border);margin-top:6px;padding-top:10px">
                <div class="key" style="font-weight:bold;color:var(--text)">üî• ‡∏°‡∏ï‡∏¥‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (Hunter)</div>
                <div class="val" id="expFinal" style="font-size:16px;font-weight:bold">-</div>
              </div>
            </div>
          </div>
    
          <div class="panel">
            <h2>üõ∞Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="kv-list">
              <div class="kv"><div class="key">‡∏ä‡∏µ‡∏û‡∏à‡∏£ "‡∏™‡∏°‡∏≠‡∏á AI"</div><div class="val err" id="statusHeartbeat">‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div></div>
              <div class="kv"><div class="key">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ "‡∏™‡∏°‡∏≠‡∏á" (DB)</div><div class="val" id="statusStorage">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</div></div>
              <div class="kv"><div class="key">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏£‡∏ß‡∏°)</div><div class="val" id="statusTotalHands">0 ‡∏ï‡∏≤</div></div>
              <div class="kv"><div class="key">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏Ç‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div><div class="val" id="statusShoeHands">0 ‡∏ï‡∏≤</div></div>
            </div>
          </div>

          <div class="panel">
            <h2>üïπÔ∏è ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πà‡∏ß‡∏ô</h2>
            <div style="display:flex;flex-wrap:wrap;gap:8px" id="quickControls">
              <button class="btn-small" onclick="onUndo()">UNDO (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</button>
              <button class="btn-small" onclick="onNewShoe()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà‡πÉ‡∏´‡∏°‡πà</button>
              <button class="btn-small" onclick="onEditHistory()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
              <button class="btn-small" onclick="onDeleteShoe()" style="background:var(--error);color:var(--text)">üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            </div>
          </div>
        </div> </div> </div> </div> <div class="modal-overlay" id="historyHubModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üóÇÔ∏è ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
      <div class="modal-close" onclick="closeModal('historyHubModal')">&times;</div>
    </div>
    
    <div class="panel" style="margin-bottom: 12px;">
        <h2>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û (Global)</h2>
        <div class="kv-list" id="hubGlobalStats">
            <div class="kv"><div class="key">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏£‡∏ß‡∏°)</div><div class="val">- ‡∏ï‡∏≤</div></div>
            <div class="kv"><div class="key">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà (‡∏£‡∏ß‡∏°)</div><div class="val">- ‡∏Ç‡∏≠‡∏ô</div></div>
        </div>
    </div>
    
    <div class="panel" style="margin-bottom: 12px;">
        <h2>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û 'Shadow Mode' (‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û)</h2>
        <div class="kv-list" id="hubExpertPerf">
            </div>
    </div>
    
    <div class="panel">
      <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà</h2>
      <div id="shoeHistorySummary" style="max-height: 150px; overflow-y: auto; font-size: 13px; color: var(--text-muted);">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
      </div>
    </div>
    
  </div>
</div>
<div class="modal-overlay" id="settingsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
      <div class="modal-close" onclick="closeModal('settingsModal')">&times;</div>
    </div>
    
    <h3>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° AI</h3>
    <div class="kv" style="margin-bottom:10px">
      <div class="key" style="font-size:14px">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (Trigger)</div>
      <div class="val" id="settingsRiskLabel">Balanced (5/9)</div>
    </div>
    <input type="range" min="1" max="9" value="5" class="slider" id="settingsRiskSlider" style="width:100%">
    <div style="font-size:12px;color:var(--text-muted;margin-top:4px">‡∏õ‡∏£‡∏±‡∏ö "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÇ‡∏´‡∏ß‡∏ï" ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà AI (Hunter) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á Signal (‡∏™‡∏π‡∏á = ‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Ç‡∏∂‡πâ‡∏ô)</div>
    <div class="slider-controls">
        <button class="btn-small" onclick="onSetTriggerDefault()">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
        <button class="btn-small" onclick="onCancelTrigger()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-small" onclick="onSaveTrigger()" style="background:var(--green);color:var(--text)">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
    
    <h3 style="margin-top:20px">‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Performance)</h3>
    <div class="kv-list">
        <div class="kv">
            <div class="key">‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô<br><span style="font-size:11px; color:var(--text-dark)">(‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span></div>
            <input type="checkbox" id="togglePowerMode" onchange="onTogglePowerMode(this.checked)">
        </div>
        <div class="kv">
            <div class="key">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á</div>
            <input type="checkbox" id="toggleHaptics" onchange="onToggleHaptics(this.checked)">
        </div>
    </div>

    <h3 style="margin-top:20px">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡∏™‡∏°‡∏≠‡∏á" (Backup)</h3>
    <p style="font-size:13px;color:var(--text-muted);line-height:1.5">
      "‡∏™‡∏°‡∏≠‡∏á" (IndexedDB) ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏≤‡∏á Chrome ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢! <br>
      ‡πÉ‡∏´‡πâ‡∏Å‡∏î **Export** ‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" (‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) ‡πÑ‡∏ß‡πâ
      ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ **Import** ‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"
    </p>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:16px">
      <button class="btn-small" onclick="onExportCSV()">üíæ Export ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (CSV)</button>
      <button class="btn-small" onclick="onImportCSV()">‚§¥Ô∏è Import ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (CSV)</button>
      <button class="btn-small" onclick="onRetrain()" style="background:var(--warn);color:#000">üîÅ ‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏≤‡∏Å Import)</button>
    </div>
    <textarea id="csvPasteArea" rows="4" style="width:100%;margin-top:10px;background:#050505;color:#fff;padding:8px;border-radius:6px" placeholder="‡∏´‡∏£‡∏∑‡∏≠ '‡∏ß‡∏≤‡∏á' ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
    
    <h3 style="margin-top:20px">‡πÇ‡∏ã‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤)</h3>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:16px">
        <button class="btn-small" onclick="onRunBIST()" style="background:var(--warn);color:#000">ü©∫ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏≠‡∏á (BIST)</button>
        <button class="btn-small" onclick="onClearMemory()" style="background:var(--red);color:var(--text)">üî• ‡∏•‡πâ‡∏≤‡∏á "‡∏™‡∏°‡∏≠‡∏á" (IndexedDB)</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="helpModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
      <div class="modal-close" onclick="closeModal('helpModal')">&times;</div>
    </div>
    <div class="tooltip-content">
      <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà OC Baccarat AI (God-Tier)!</p>
      <p><strong>‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Smart Interface)</strong><br>
         - <strong>‡πÅ‡∏ï‡∏∞ (Tap):</strong> ‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (`PLAYER` ‡∏´‡∏£‡∏∑‡∏≠ `BANKER`) AI ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô `_UNKNOWN` (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏û‡πà)<br>
         - <strong>‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á (Hold):</strong> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (`2 ‡πÉ‡∏ö` ‡∏´‡∏£‡∏∑‡∏≠ `3 ‡πÉ‡∏ö`)
      </p>
      <p><strong>Signal ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? (‡∏£‡∏∞‡∏ö‡∏ö Hunter)</strong><br>
         AI ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á `"-"` (‡∏£‡∏≠) ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á Signal (P/B) ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏ï‡∏≤‡∏ó‡∏µ‡πà "‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à" ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Trigger)</p>
      <p><strong>Big Road (‡∏ó‡∏∂‡∏ö vs ‡πÇ‡∏õ‡∏£‡πà‡∏á)</strong><br>
         - <strong>‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ó‡∏∂‡∏ö (P/B):</strong> ‡∏ä‡∏ô‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏û‡πà 2 ‡πÉ‡∏ö (P2 / B2)<br>
         - <strong>‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á (P/B):</strong> ‡∏ä‡∏ô‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏û‡πà 3 ‡πÉ‡∏ö (P3 / B3)<br>
         - <strong>‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÜ (‡∏à‡∏≤‡∏á):</strong> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" (`_UNKNOWN`)
      </p>
      <p><strong>TIE (‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏â‡∏µ‡∏¢‡∏á)</strong><br>
         ‡∏ú‡∏•‡πÄ‡∏™‡∏°‡∏≠ `T` ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏â‡∏µ‡∏¢‡∏á" ‡∏ó‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå P/B ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≤‡∏™‡∏¥‡πÇ‡∏ô‡∏à‡∏£‡∏¥‡∏á)
      </p>
      <p><strong>Backup (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)</strong><br>
         "‡∏™‡∏°‡∏≠‡∏á" AI (IndexedDB) ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏≤‡∏á Chrome ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢! ‡∏Å‡∏î <strong>‚öôÔ∏è (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤) > Export CSV</strong> ‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" (‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) ‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏Å‡∏î Import CSV ‡πÅ‡∏•‡∏∞ "‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"
      </p>
    </div>
  </div>
</div>

<div class="modal-overlay" id="historyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History Editor)</h2>
      <div class="modal-close" onclick="closeModal('historyModal')">&times;</div>
    </div>
    <p style="font-size:13px;color:var(--text-muted;line-height:1.5">
      ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏∞ (‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏û‡∏•‡∏≤‡∏î) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏≠‡∏á AI
    </p>
    <div style="margin-top:16px; margin-bottom:10px;">
        <label for="historyFilter">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
        <select id="historyFilter">
            <option value="all">‡πÅ‡∏™‡∏î‡∏á 100 ‡∏ï‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="unknown">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' (Back-fill Mode)</option>
        </select>
    </div>
    <div style="max-height:400px;overflow-y:auto;border:1px solid var(--card-border);border-radius:8px">
      <table id="historyEditorTable">
        <thead>
          <tr>
            <th>‡∏ï‡∏≤‡∏ó‡∏µ‡πà</th>
            <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
            <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô...</th>
          </tr>
        </thead>
        <tbody id="historyEditorBody">
          </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal-content">
    <h2 id="confirmModalTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h2>
    <p id="confirmModalBody">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    <div id="confirmModalButtons">
        <button class="btn-small" id="confirmBtnNo" style="flex:1">üü¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</button>
        <button class="btn-small" id="confirmBtnYes" style="flex:1; background:var(--error); color:var(--text)">üî¥ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>
  </div>
</div>


<div class="status-overlay" id="fatalErrorOverlay">
  <h1>‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á</h1>
  <p id="fatalErrorMessage">"‡∏™‡∏°‡∏≠‡∏á AI" (Web Worker) ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ "‡∏õ‡∏¥‡∏î" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏õ‡∏¥‡∏î" ‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Restart)</p>
</div>

<div class="status-overlay" id="retrainOverlay">
  <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h1>
  <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (CSV) ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏™‡∏°‡∏≠‡∏á" (IndexedDB) ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà...<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>
  <div id="retrainProgress">
    <div id="retrainProgressBar"></div>
  </div>
  <p style="margin-top:10px;font-size:14px" id="retrainStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</p>
</div>


<script>
// ========== PART 2: MAIN THREAD JAVASCRIPT ==========
// ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠" (UI) ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏ò‡∏£‡∏î‡∏´‡∏•‡∏±‡∏Å"
// ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI, ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö "‡∏™‡∏°‡∏≠‡∏á" (Web Worker)

// 1. DOM Elements (‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î)
const ui = {
    loadingOverlay: document.getElementById('loadingOverlay'),
    app: document.getElementById('app'),
    
    appStatus: document.getElementById('appStatus'),
    predCircle: document.getElementById('predCircle'),
    confText: document.getElementById('confText'),
    condBox: document.getElementById('condBox'),
    progressBar: document.getElementById('progressBar'),
    countdownText: document.getElementById('countdownText'),
    controlsGrid: document.getElementById('controlsGrid'),
    quickControls: document.getElementById('quickControls'),
    
    // (Smart Interface 3 ‡∏õ‡∏∏‡πà‡∏°)
    btnPlayer: document.getElementById('btnPlayer'),
    btnBanker: document.getElementById('btnBanker'),
    btnTie: document.getElementById('btnTie'),
    flyoutP: document.getElementById('flyoutP'),
    flyoutB: document.getElementById('flyoutB'),
    
    winRateShoe: document.getElementById('winRateShoe'),
    winShoe: document.getElementById('winShoe'),
    loseShoe: document.getElementById('loseShoe'),
    winRateGlobal: document.getElementById('winRateGlobal'),
    winGlobal: document.getElementById('winGlobal'),
    loseGlobal: document.getElementById('loseGlobal'),
    
    bigroad: document.getElementById('bigroad'),
    
    aiDashboard: document.getElementById('aiDashboard'),
    // (9 Experts)
    expMain: document.getElementById('expMain'),
    expDerived: document.getElementById('expDerived'),
    expRules: document.getElementById('expRules'),
    expStats: document.getElementById('expStats'),
    expSpecial: document.getElementById('expSpecial'),
    expSimA: document.getElementById('expSimA'),
    expSimB: document.getElementById('expSimB'),
    expSimC: document.getElementById('expSimC'),
    expMiner: document.getElementById('expMiner'),
    expFinal: document.getElementById('expFinal'),
    
    statusHeartbeat: document.getElementById('statusHeartbeat'),
    statusStorage: document.getElementById('statusStorage'),
    statusTotalHands: document.getElementById('statusTotalHands'),
    statusShoeHands: document.getElementById('statusShoeHands'),
    shoeHistorySummary: document.getElementById('shoeHistorySummary'),
    
    // (Modals)
    dashboardModal: document.getElementById('dashboardModal'),
    historyHubModal: document.getElementById('historyHubModal'), // (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° ‚ÄºÔ∏è‚ÄºÔ∏è)
    settingsModal: document.getElementById('settingsModal'),
    helpModal: document.getElementById('helpModal'),
    historyModal: document.getElementById('historyModal'),
    confirmModal: document.getElementById('confirmModal'),
    confirmModalTitle: document.getElementById('confirmModalTitle'),
    confirmModalBody: document.getElementById('confirmModalBody'),
    confirmBtnYes: document.getElementById('confirmBtnYes'),
    confirmBtnNo: document.getElementById('confirmBtnNo'),

    historyEditorBody: document.getElementById('historyEditorBody'),
    historyFilter: document.getElementById('historyFilter'),
    
    fatalErrorOverlay: document.getElementById('fatalErrorOverlay'),
    fatalErrorMessage: document.getElementById('fatalErrorMessage'),
    retrainOverlay: document.getElementById('retrainOverlay'),
    retrainProgressBar: document.getElementById('retrainProgressBar'),
    retrainStatus: document.getElementById('retrainStatus'),
    
    csvPasteArea: document.getElementById('csvPasteArea'),
    settingsRiskSlider: document.getElementById('settingsRiskSlider'),
    settingsRiskLabel: document.getElementById('settingsRiskLabel'),
    
    advancedPanels: document.getElementById('advancedPanels'),
    
    // (Power Management)
    togglePowerMode: document.getElementById('togglePowerMode'),
    toggleHaptics: document.getElementById('toggleHaptics'),
};

// 2. State (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
let aiWorker = null;
let countdownInterval = null;
let currentCountdown = 20;
const COUNTDOWN_START = 20;
let holdTimer = null;
let isHolding = false;
const HOLD_DURATION = 400; // (0.4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
// (State ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)
let currentTriggerValue = 5;
let appSettings = {
    powerMode: false,
    haptics: true
};
// (State ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
let confirmCallback = null;

// 3. Worker Initialization (‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó "‡∏™‡∏°‡∏≠‡∏á")
function initializeWorker() {
    if (window.Worker) {
        document.getElementById('loaderStatus').textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó '‡∏™‡∏°‡∏≠‡∏á AI'...";
        try {
            aiWorker = new Worker('worker.js'); 
            aiWorker.onmessage = handleWorkerMessage;
            aiWorker.onerror = handleWorkerError;
            
            // (‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Setting ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)
            loadSettings(); 
            
            const config = {
                riskThreshold: currentTriggerValue,
                powerMode: appSettings.powerMode
            };
            aiWorker.postMessage({ command: 'INIT', config: config });
            
            startHeartbeat();
        } catch (e) {
            console.error("Worker failed to start:", e);
            showFatalError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô '‡∏™‡∏°‡∏≠‡∏á AI' (worker.js) ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô");
        }
    } else {
        console.error("Web Workers not supported");
        showFatalError("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Workers ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô AI ‡πÑ‡∏î‡πâ");
    }
}

// 4. Worker Communication (‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö "‡∏™‡∏°‡∏≠‡∏á")

// A. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å "‡∏™‡∏°‡∏≠‡∏á"
function handleWorkerMessage(e) {
    const data = e.data;
    
    switch (data.command) {
        case 'INIT_COMPLETE':
            // (‡πÅ‡∏Å‡πâ‡πÅ‡∏ú‡∏• "‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πâ‡∏≤")
            ui.loadingOverlay.style.display = 'none'; 
            ui.app.style.display = 'block'; 
            
            ui.appStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ '‡∏™‡∏°‡∏≠‡∏á' ‡πÅ‡∏•‡πâ‡∏ß)";
            ui.statusHeartbeat.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
            ui.statusHeartbeat.className = "val ok";
            aiWorker.postMessage({ command: 'LOAD_LAST_STATE' });
            break;
            
        case 'LAST_STATE_LOADED':
            updateUI(data.state);
            break;
            
        case 'ANALYSIS_COMPLETE':
            // (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: Haptic "Hunter" ‚ÄºÔ∏è‚ÄºÔ∏è)
            if (data.state.signal.finalPrediction !== '-') {
                haptic('heavy');
            }
            updateUI(data.state);
            break;
            
        case 'HEARTBEAT_PONG':
            ui.statusHeartbeat.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
            ui.statusHeartbeat.className = "val ok";
            break;
            
        case 'STORAGE_UPDATED':
            ui.statusStorage.textContent = `${(data.sizeMB || 0).toFixed(2)} MB`;
            ui.statusTotalHands.textContent = `${data.totalHands || 0} ‡∏ï‡∏≤`;
            break;
            
        case 'HISTORY_LOADED':
            renderHistoryEditor(data.history, data.filter);
            break;
            
        case 'SHOE_SUMMARY_LOADED':
            renderShoeSummary(data.summary);
            break;
            
        case 'BIST_RESULT':
            alert(`[‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏≠‡∏á]\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ${data.passed ? '‡∏õ‡∏Å‡∏ï‡∏¥ (100%)' : '‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤!'}\n\n${data.message}`);
            break;
            
        case 'RETRAIN_PROGRESS':
            ui.retrainOverlay.style.display = 'flex';
            ui.retrainProgressBar.style.width = `${data.progress}%`;
            ui.retrainStatus.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${data.message}`;
            break;
            
        case 'RETRAIN_COMPLETE':
            ui.retrainOverlay.style.display = 'none';
            alert('‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            aiWorker.postMessage({ command: 'LOAD_LAST_STATE' });
            break;

        case 'EXPORT_DATA':
            downloadCSV(data.csvString, 'oc_history_backup.csv');
            break;
            
        case 'ACTION_FAILED':
            alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.message}`);
            // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
            setControlsDisabled(false);
            break;
            
        case 'FATAL_ERROR_FROM_WORKER':
            showFatalError(data.message);
            break;
    }
}

// B. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠ "‡∏™‡∏°‡∏≠‡∏á" ‡∏û‡∏±‡∏á
function handleWorkerError(e) {
    console.error("Fatal Worker Error:", e.message, e.filename, e.lineno);
    showFatalError(`'‡∏™‡∏°‡∏≠‡∏á AI' ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏∞‡∏ó‡∏±‡∏ô‡∏´‡∏±‡∏ô (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${e.lineno}: ${e.message})`);
}

// C. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á (Heartbeat Fail)
function showFatalError(message) {
    ui.loadingOverlay.style.display = 'none';
    ui.app.style.display = 'none';
    
    stopHeartbeat();
    ui.fatalErrorMessage.innerHTML = message + "<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ '‡∏õ‡∏¥‡∏î' ‡πÅ‡∏•‡∏∞ '‡πÄ‡∏õ‡∏¥‡∏î' ‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Restart)";
    ui.fatalErrorOverlay.style.display = 'flex';
    if (aiWorker) {
        aiWorker.terminate();
        aiWorker = null;
    }
}

// 5. Heartbeat (‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ä‡∏µ‡∏û‡∏à‡∏£)
let heartbeatInterval = null;
function startHeartbeat() {
    stopHeartbeat();
    heartbeatInterval = setInterval(() => {
        if (!aiWorker) {
            stopHeartbeat();
            return;
        }
        try {
            ui.statusHeartbeat.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
            ui.statusHeartbeat.className = "val warn";
            aiWorker.postMessage({ command: 'HEARTBEAT_PING' });
            
            setTimeout(() => {
                if (ui.statusHeartbeat.textContent === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...") {
                    showFatalError("'‡∏™‡∏°‡∏≠‡∏á AI' (Web Worker) ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô");
                }
            }, 3000); 

        } catch (e) {
            showFatalError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö '‡∏™‡∏°‡∏≠‡∏á AI' ‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏Ñ‡∏£‡∏ä)`);
        }
    }, 10000); 
}
function stopHeartbeat() {
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }
}

// 6. UI Update Functions (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)

// A. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function updateUI(state) {
    if (!state) {
        setControlsDisabled(false); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏ú‡∏∑‡πà‡∏≠
        return;
    }
    
    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Signal ‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏∞‡∏ö‡∏ö Hunter)
    const pred = state.signal.finalPrediction || '-';
    ui.predCircle.textContent = pred;
    
    // (‡πÅ‡∏Å‡πâ‡πÅ‡∏ú‡∏• "AI ‡∏ï‡∏≤‡∏¢") - "‡∏ä‡∏µ‡∏û‡∏à‡∏£"
    if (pred === '-' && !appSettings.powerMode) {
        ui.predCircle.className = 'pred-circle waiting';
        ui.condBox.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå... (‡∏£‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ${state.signal.condition})`;
    } else {
        ui.predCircle.className = `pred-circle ${pred}`;
        ui.condBox.textContent = `‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ${state.signal.condition || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏•...'}`;
    }
    
    ui.confText.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${state.signal.confidence || 0}%`;
    
    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Winrate
    ui.winRateShoe.textContent = `${state.stats.shoe.winrate || 0} %`;
    ui.winShoe.textContent = state.stats.shoe.wins || 0;
    ui.loseShoe.textContent = state.stats.shoe.losses || 0;
    ui.winRateGlobal.textContent = `${state.stats.global.winrate || 0} %`;
    ui.winGlobal.textContent = state.stats.global.wins || 0;
    ui.loseGlobal.textContent = state.stats.global.losses || 0;
    
    // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î AI (Shadow Mode)
    updateExpertDashboard(state.signal.expertVotes || {}, state.expertPerformance || {});
    
    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
    ui.statusStorage.textContent = `${(state.stats.storageSizeMB || 0).toFixed(2)} MB`;
    ui.statusTotalHands.textContent = `${state.stats.global.totalHands || 0} ‡∏ï‡∏≤`;
    ui.statusShoeHands.textContent = `${state.stats.shoe.totalHands || 0} ‡∏ï‡∏≤`;

    // 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Big Road
    renderBigRoad(state.history.shoe);
    
    // 6. (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡πÅ‡∏Å‡πâ‡πÅ‡∏ú‡∏• "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ß")
    setControlsDisabled(false);
}

// B. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î AI (Shadow Mode)
function updateExpertDashboard(votes, performance) {
    const setVote = (el, vote) => {
        if (!vote || vote === 'WAIT') {
            el.textContent = '-';
            el.className = 'val';
        } else {
            el.textContent = vote;
            el.className = `val ${vote}`;
        }
    };
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Winrate ‡∏Ç‡∏≠‡∏á Expert)
    const setPerf = (key) => {
        const perf = performance[key];
        const el = document.getElementById(`perf${key.charAt(0).toUpperCase() + key.slice(1)}`); // (‡∏´‡∏≤ perfMain, perfDerived)
        if (!el) return;
        
        if (perf && perf.total > 0) {
            const winrate = Math.round((perf.wins / perf.total) * 100);
            el.textContent = `${winrate}%`;
        } else {
            el.textContent = `--%`;
        }
    };
    
    setVote(ui.expMain, votes.main); setPerf('main');
    setVote(ui.expDerived, votes.derived); setPerf('derived');
    setVote(ui.expRules, votes.rules); setPerf('rules');
    setVote(ui.expStats, votes.stats); setPerf('stats');
    setVote(ui.expSpecial, votes.special); setPerf('special');
    setVote(ui.expSimA, votes.simA); setPerf('simA');
    setVote(ui.expSimB, votes.simB); setPerf('simB');
    setVote(ui.expSimC, votes.simC); setPerf('simC');
    setVote(ui.expMiner, votes.miner); setPerf('miner');
    
    setVote(ui.expFinal, votes.finalPrediction);
}

// C. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Big Road
function renderBigRoad(history) {
    ui.bigroad.innerHTML = '';
    if (!history || history.length === 0) return;
    
    const cols = [];
    let tieCount = 0; // (‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö TIE)
    
    history.forEach(hand => {
        const result = hand.result;
        const mainResult = result[0];
        
        if (mainResult === 'T') {
            tieCount++; // (‡∏à‡∏≥ TIE ‡πÑ‡∏ß‡πâ)
            return; // (‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÉ‡∏´‡∏°‡πà)
        }
        
        let handData = { hand: hand, ties: tieCount };
        tieCount = 0; // (‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö TIE)
        
        if (cols.length === 0) {
            cols.push([handData]);
            return;
        }
        
        let lastCol = cols[cols.length - 1];
        let lastHandData = lastCol[lastCol.length - 1];
        let lastMainResult = lastHandData.hand.result[0];
        
        if (mainResult === lastMainResult) {
            lastCol.push(handData);
        } else {
            cols.push([handData]); 
        }
    });
    
    cols.forEach(col => {
        const divCol = document.createElement('div');
        divCol.className = 'br-col';
        col.forEach(handData => {
            const cell = document.createElement('div');
            const hand = handData.hand;
            // (‡πÅ‡∏Å‡πâ‡πÅ‡∏ú‡∏• "TIE Line")
            const cellClass = 'br-' + (hand.result === 'T' ? 'T' : hand.result.replace('2', ''));
            cell.className = `br-cell ${cellClass}`;
            cell.textContent = hand.result[0];
            
            // (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ TIE ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô)
            if (handData.ties > 0) {
                const tieLine = document.createElement('div');
                tieLine.className = 'tie-line';
                cell.appendChild(tieLine);
                // (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ TIE ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
                if (handData.ties > 1) {
                    tieLine.textContent = handData.ties;
                    tieLine.style.color = 'white';
                    tieLine.style.fontSize = '12px';
                    tieLine.style.textAlign = 'center';
                }
            }
            
            divCol.appendChild(cell);
        });
        ui.bigroad.appendChild(divCol);
    });
    
    ui.bigroad.scrollLeft = ui.bigroad.scrollWidth;
}

// D. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
function renderHistoryEditor(history, filter) {
    ui.historyEditorBody.innerHTML = '';
    if (!history || history.length === 0) {
        ui.historyEditorBody.innerHTML = '<tr><td colspan="3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>';
        return;
    }
    
    let filteredHistory = history;
    if (filter === 'unknown') {
        filteredHistory = history.filter(h => h.result.includes('_UNKNOWN'));
    }
    
    const recentHistory = filteredHistory.slice(-100).reverse();
    
    recentHistory.forEach(hand => {
        const row = document.createElement('tr');
        const cellId = document.createElement('td');
        cellId.textContent = `‡∏ï‡∏≤‡∏ó‡∏µ‡πà ${hand.id}`;
        row.appendChild(cellId);
        
        const cellResult = document.createElement('td');
        cellResult.textContent = hand.result;
        row.appendChild(cellResult);
        
        const cellAction = document.createElement('td');
        const select = document.createElement('select');
        select.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà --</option>
                          <option value="P_UNKNOWN">PLAYER (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option>
                          <option value="P2">PLAYER 2 ‡πÉ‡∏ö</option>
                          <option value="P3">PLAYER 3 ‡πÉ‡∏ö</option>
                          <option value="B_UNKNOWN">BANKER (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option>
                          <option value="B2">BANKER 2 ‡πÉ‡∏ö</option>
                          <option value="B3">BANKER 3 ‡πÉ‡∏ö</option>
                          <option value="T">TIE</option>`;
        select.onchange = () => {
            const newValue = select.value;
            if (newValue) {
                showConfirm(
                    `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç`,
                    `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ï‡∏≤‡∏ó‡∏µ‡πà ${hand.id} ‡∏à‡∏≤‡∏Å ${hand.result} ‡πÄ‡∏õ‡πá‡∏ô ${newValue} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                    () => {
                        setControlsDisabled(true);
                        ui.predCircle.textContent = '...';
                        ui.condBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...";
                        
                        aiWorker.postMessage({ command: 'EDIT_HISTORY', handId: hand.id, newResult: newValue });
                        closeModal('historyModal');
                    }
                );
            }
        };
        cellAction.appendChild(select);
        row.appendChild(cellAction);
        
        ui.historyEditorBody.appendChild(row);
    });
}

// (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: "‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà" ‚ÄºÔ∏è‚ÄºÔ∏è)
function renderShoeSummary(summary) {
    if (!summary || summary.length === 0) {
        ui.shoeHistorySummary.innerHTML = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà';
        return;
    }
    ui.shoeHistorySummary.innerHTML = '';
    summary.reverse().forEach(shoe => {
        const div = document.createElement('div');
        div.style.borderBottom = `1px solid var(--card-border)`;
        div.style.padding = `8px 4px`;
        div.innerHTML = `<strong>‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà #${shoe.id}</strong> (${shoe.isCurrent ? '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß'})<br>
                         P: ${shoe.P} | B: ${shoe.B} | T: ${shoe.T} (‡∏£‡∏ß‡∏° ${shoe.totalHands} ‡∏ï‡∏≤)`;
        ui.shoeHistorySummary.appendChild(div);
    });
}


// 7. Countdown Timer (‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤)
function startCountdown() {
    stopCountdown();
    currentCountdown = COUNTDOWN_START;
    ui.countdownText.textContent = `${currentCountdown}s`;
    
    countdownInterval = setInterval(() => {
        currentCountdown--;
        ui.countdownText.textContent = `${currentCountdown}s`;
        if (currentCountdown <= 5) {
            ui.countdownText.style.color = 'var(--error)';
        } else if (currentCountdown <= 10) {
            ui.countdownText.style.color = 'var(--warn)';
        }
        
        if (currentCountdown <= 0) {
            stopCountdown();
            ui.countdownText.textContent = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤';
        }
    }, 1000);
}
function stopCountdown() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    ui.countdownText.style.color = 'var(--warn)';
}
function resetCountdown() {
    stopCountdown();
    startCountdown();
}


// 8. User Actions (‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)

// (Haptic Feedback)
function haptic(type = 'light') {
    if (appSettings.haptics && window.navigator.vibrate) {
        if (type === 'light') window.navigator.vibrate(50); // (‡πÅ‡∏ï‡∏∞)
        if (type === 'medium') window.navigator.vibrate(100); // (‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á)
        if (type === 'heavy') window.navigator.vibrate([100, 50, 100]); // (Signal ‡∏°‡∏≤)
    }
}

// (‡∏•‡πá‡∏≠‡∏Ñ/‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î)
function setControlsDisabled(disabled) {
    ui.btnPlayer.disabled = disabled;
    ui.btnBanker.disabled = disabled;
    ui.btnTie.disabled = disabled;
    ui.btnPlayer.style.opacity = disabled ? 0.5 : 1;
    ui.btnBanker.style.opacity = disabled ? 0.5 : 1;
    ui.btnTie.style.opacity = disabled ? 0.5 : 1;
    
    const quickControls = ui.quickControls.getElementsByTagName('button');
    for (const button of quickControls) {
        button.disabled = disabled;
        button.style.opacity = disabled ? 0.5 : 1;
    }
}


// (Smart Interface '‡πÅ‡∏ï‡∏∞ / ‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á')
function setupSmartControls() {
    const attachListeners = (button, lazyResult, flyout) => {
        button.addEventListener('touchstart', (e) => {
            if (button.disabled) return;
            e.preventDefault(); 
            isHolding = false;
            holdTimer = setTimeout(() => {
                isHolding = true;
                haptic('medium');
                flyout.style.display = 'block';
            }, HOLD_DURATION);
        }, { passive: false });
        
        button.addEventListener('touchend', (e) => {
            if (button.disabled) return;
            e.preventDefault();
            clearTimeout(holdTimer);
            if (!isHolding) {
                haptic('light');
                onResult(lazyResult); 
            }
        });
        
        // (Desktop)
         button.addEventListener('mousedown', (e) => {
            if (button.disabled) return;
            if (e.button === 2) { 
                 e.preventDefault();
                 flyout.style.display = 'block';
            }
         });
         button.addEventListener('click', (e) => {
             if (button.disabled) return;
             haptic('light');
             onResult(lazyResult);
         });
         document.addEventListener('click', (e) => {
            if (flyout && !flyout.contains(e.target) && !button.contains(e.target)) {
                flyout.style.display = 'none';
            }
         });
    };
    
    attachListeners(ui.btnPlayer, 'P_UNKNOWN', ui.flyoutP);
    attachListeners(ui.btnBanker, 'B_UNKNOWN', ui.flyoutB);
    
    ui.btnTie.addEventListener('click', () => { 
        haptic('light'); 
        onResult('T'); 
    });
}


// A. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á)
window.onResult = function(result) { 
    if (!aiWorker) return alert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "‡∏™‡∏°‡∏≠‡∏á AI" ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
    
    ui.flyoutP.style.display = 'none';
    ui.flyoutB.style.display = 'none';
    
    resetCountdown();
    setControlsDisabled(true);
    
    ui.predCircle.textContent = '...';
    ui.predCircle.className = 'pred-circle';
    ui.condBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
    
    aiWorker.postMessage({ command: 'ADD_HAND', result: result });
}

// (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: "‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô '‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î'" ‚ÄºÔ∏è‚ÄºÔ∏è)
function showConfirm(title, body, callback) {
    ui.confirmModalTitle.textContent = title;
    ui.confirmModalBody.textContent = body;
    
    ui.confirmBtnYes.onclick = () => {
        closeModal('confirmModal');
        if (callback) callback();
    };
    ui.confirmBtnNo.onclick = () => {
        closeModal('confirmModal');
    };
    
    openModal('confirmModal');
}

// B. ‡∏Å‡∏î Undo
window.onUndo = function() {
    if (!aiWorker) return;
    showConfirm(
        '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ UNDO',
        '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å "‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß" ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        () => {
            setControlsDisabled(true);
            ui.predCircle.textContent = '...';
            ui.condBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö...";
            aiWorker.postMessage({ command: 'UNDO_LAST_HAND' });
        }
    );
}

// C. ‡∏Å‡∏î ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà‡πÉ‡∏´‡∏°‡πà
window.onNewShoe = function() {
    if (!aiWorker) return;
    showConfirm(
        '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà‡πÉ‡∏´‡∏°‡πà',
        '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Winrate (‡∏Ç‡∏≠‡∏ô‡∏ô‡∏µ‡πâ) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        () => {
            setControlsDisabled(true);
            ui.predCircle.textContent = '...';
            ui.condBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà...";
            
            // (Optimistic Update)
            ui.winRateShoe.textContent = `- %`;
            ui.winShoe.textContent = 0;
            ui.loseShoe.textContent = 0;
            ui.statusShoeHands.textContent = `0 ‡∏ï‡∏≤`;
            renderBigRoad([]);
            
            aiWorker.postMessage({ command: 'NEW_SHOE' });
            resetCountdown();
        }
    );
}

// (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: "‡∏•‡∏ö‡∏Ç‡∏≠‡∏ô‡∏ô‡∏µ‡πâ" ‚ÄºÔ∏è‚ÄºÔ∏è)
window.onDeleteShoe = function() {
    if (!aiWorker) return;
    showConfirm(
        '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà',
        '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏•‡∏ö" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á "‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏≤‡∏ß‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ç‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)',
        () => {
            setControlsDisabled(true);
            ui.predCircle.textContent = '...';
            ui.condBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà...";
            aiWorker.postMessage({ command: 'DELETE_CURRENT_SHOE' });
        }
    );
}


// D. ‡∏Å‡∏î ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
window.onEditHistory = function() {
    if (!aiWorker) return;
    ui.historyFilter.value = 'all';
    aiWorker.postMessage({ command: 'GET_HISTORY', filter: 'all' });
    openModal('historyModal');
}
ui.historyFilter.onchange = () => {
     aiWorker.postMessage({ command: 'GET_HISTORY', filter: ui.historyFilter.value });
};


// E. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI Risk (‚ÄºÔ∏è‚ÄºÔ∏è "‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î" ‚ÄºÔ∏è‚ÄºÔ∏è)
ui.settingsRiskSlider.oninput = function() {
    ui.settingsRiskLabel.textContent = `(${this.value}/9 ‡πÄ‡∏™‡∏µ‡∏¢‡∏á)`;
};
window.onSaveTrigger = function() {
    const newValue = parseInt(ui.settingsRiskSlider.value, 10);
    currentTriggerValue = newValue; // (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà)
    saveSettings(); // (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage)
    aiWorker.postMessage({ command: 'UPDATE_CONFIG', config: { riskThreshold: newValue } });
    alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏õ‡πá‡∏ô ${newValue}/9 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    closeModal('settingsModal');
}
window.onCancelTrigger = function() {
    ui.settingsRiskSlider.value = currentTriggerValue; // (‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°)
    ui.settingsRiskLabel.textContent = `(${currentTriggerValue}/9 ‡πÄ‡∏™‡∏µ‡∏¢‡∏á)`;
    closeModal('settingsModal');
}
window.onSetTriggerDefault = function() {
    const defaultValue = 5;
    ui.settingsRiskSlider.value = defaultValue;
    ui.settingsRiskLabel.textContent = `(${defaultValue}/9 ‡πÄ‡∏™‡∏µ‡∏¢‡∏á)`;
    // (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ã‡∏ü ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
}


// F. ‡∏Å‡∏≤‡∏£ Backup (Export/Import)
window.onExportCSV = function() {
    if (!aiWorker) return;
    showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Export', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
        ui.appStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV...";
        aiWorker.postMessage({ command: 'EXPORT_CSV' });
    });
}
window.onImportCSV = function() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const csvString = event.target.result;
            confirmImport(csvString);
        };
        reader.readAsText(file);
    };
    fileInput.click();
}
window.onRetrain = function() {
    const csvString = ui.csvPasteArea.value;
    if (!csvString || csvString.trim().length < 10) {
        return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ "‡∏ß‡∏≤‡∏á" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô\n(‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° Import CSV)');
    }
    confirmImport(csvString);
}
function confirmImport(csvString) {
    showConfirm(
        '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô! ‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà!',
        '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞ "‡∏•‡∏ö" ‡∏™‡∏°‡∏≠‡∏á AI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß "‡∏ù‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà" ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Import... ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        () => {
            if (!aiWorker) return alert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "‡∏™‡∏°‡∏≠‡∏á AI" ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
            ui.retrainOverlay.style.display = 'flex';
            ui.retrainProgressBar.style.width = '0%';
            ui.retrainStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô... (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)";
            aiWorker.postMessage({ command: 'RETRAIN_FROM_CSV', csvString: csvString });
            closeModal('settingsModal');
            ui.csvPasteArea.value = '';
        }
    );
}
function downloadCSV(csvString, filename) {
    ui.appStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°";
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    alert('Export CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Downloads ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
}


// G. ‡πÇ‡∏ã‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
window.onClearMemory = function() {
    showConfirm(
        '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢!!! ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1',
        '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏°‡∏≠‡∏á AI" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏°‡∏µ CSV Backup)',
        () => {
            showConfirm(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢!',
                '‡∏•‡∏ö‡∏™‡∏°‡∏≠‡∏á AI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => {
                    if (!aiWorker) return alert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "‡∏™‡∏°‡∏≠‡∏á AI" ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
                    aiWorker.postMessage({ command: 'CLEAR_ALL_MEMORY' });
                    alert('‡∏•‡∏ö‡∏™‡∏°‡∏≠‡∏á AI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    localStorage.removeItem('oc_baccarat_settings'); // (‡∏•‡∏ö Setting ‡∏î‡πâ‡∏ß‡∏¢)
                    location.reload();
                }
            );
        }
    );
}
// (BIST)
window.onRunBIST = function() {
    if (!aiWorker) return;
    showConfirm('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏≠‡∏á', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô IndexedDB ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
        aiWorker.postMessage({ command: 'RUN_BIST' });
    });
}

// (‚ÄºÔ∏è‚ÄºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°: Power Management ‚ÄºÔ∏è‚ÄºÔ∏è)
function saveSettings() {
    localStorage.setItem('oc_baccarat_settings', JSON.stringify({
        trigger: currentTriggerValue,
        powerMode: appSettings.powerMode,
        haptics: appSettings.haptics
    }));
}
function loadSettings() {
    const saved = localStorage.getItem('oc_baccarat_settings');
    if (saved) {
        const settings = JSON.parse(saved);
        appSettings = settings;
        currentTriggerValue = settings.trigger || 5;
    }
    // (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI)
    ui.settingsRiskSlider.value = currentTriggerValue;
    ui.settingsRiskLabel.textContent = `(${currentTriggerValue}/9 ‡πÄ‡∏™‡∏µ‡∏¢‡∏á)`;
    ui.togglePowerMode.checked = appSettings.powerMode;
    ui.toggleHaptics.checked = !appSettings.haptics;
}
window.onTogglePowerMode = function(isChecked) {
    appSettings.powerMode = isChecked;
    saveSettings();
    aiWorker.postMessage({ command: 'UPDATE_CONFIG', config: { powerMode: isChecked } });
    alert('‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô: ' + (isChecked ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'));
}
window.onToggleHaptics = function(isChecked) {
    appSettings.haptics = !isChecked; // (Checkbox ‡∏Ñ‡∏∑‡∏≠ "‡∏õ‡∏¥‡∏î")
    saveSettings();
}


// 9. Modal Controls (‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á)
window.openModal = function(id) { 
    if (id === 'historyHubModal') {
        // (‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡πÉ‡∏´‡πâ History Hub ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏ô‡πÑ‡∏û‡πà)
        aiWorker.postMessage({ command: 'GET_SHOE_SUMMARY' });
    }
    document.getElementById(id).style.display = 'block'; 
}
window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }


// 10. Start Application (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏õ!)
initializeWorker();
resetCountdown(); 
setupSmartControls(); // (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö '‡πÅ‡∏ï‡∏∞/‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á')

</script>

</body>
</html>
